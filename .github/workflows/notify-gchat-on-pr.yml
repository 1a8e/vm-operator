name: notify-gchat-on-pr
on:
  pull_request_target:
    types:
    - opened
    - reopened
jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
    - name: Google Chat Notification
      env:
        GOOGLE_SPACE_URL: ${{ secrets.GOOGLE_SPACE_URL }}
        GITHUB_THREAD_KEY: ${{ github.event.pull_request.number }}
        GITHUB_EVENT_NUMBER: ${{ github.event.pull_request.number }}
        GITHUB_EVENT_STATE: ${{ github.event.issue.state }}
        GITHUB_EVENT_TITLE: ${{ github.event.pull_request.title }}
        GITHUB_EVENT_USER: ${{ github.event.pull_request.user.login }}
        GITHUB_EVENT_URL: ${{ github.event.pull_request.html_url }}
        GITHUB_EVENT_LABELS: ${{ join(github.event.pull_request.labels.*.name) }}
        GITHUB_EVENT_ASSIGNEES: ${{ join(github.event.pull_request.assignees.*.login) }}
      run: |
        curl --location --request POST "${GOOGLE_SPACE_URL}&messageReplyOption=REPLY_MESSAGE_FALLBACK_TO_NEW_THREAD" \
        --header 'Content-Type: application/json' \
        --data-raw '{
            "thread": {"threadKey": "'"${GITHUB_THREAD_KEY}"'"},
            "cards": [
              {
                "header": {
                  "title": "Pull Request Tracker",
                  "subtitle": "PR Number: #${{ github.event.pull_request.number }}"
                },
                "sections": [
                  {
                    "widgets": [
                      {
                        "keyValue": {
                          "topLabel": "Creator",
                          "content": "'"${GITHUB_EVENT_USER}"'"
                        }
                      },
                      {
                        "keyValue": {
                          "topLabel": "Title",
                          "content": "'"${GITHUB_EVENT_TITLE}"'"
                        }
                      },
                      {
                        "keyValue": {
                          "topLabel": "State",
                          "content": "'"${GITHUB_EVENT_STATE}"'"
                        }
                      },
                      {
                        "keyValue": {
                          "topLabel": "Labels",
                          "content": "- '"${GITHUB_EVENT_LABELS}"'"
                        }
                      },
                      {
                        "keyValue": {
                          "topLabel": "Assignees",
                          "content": "- '"${GITHUB_EVENT_ASSIGNEES}"'"
                        }
                      },
                      {
                        "buttons": [
                          {
                            "textButton": {
                              "text": "OPEN PR",
                              "onClick": {
                                "openLink": {
                                  "url": "'"${GITHUB_EVENT_URL}"'"
                                }
                              }
                            }
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }'
